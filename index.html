<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistem Manajemen Siswa</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background-color: #f4f4f4;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    h1, h2 {
      text-align: center;
      color: #333;
    }
    .login-section, .form-section, .table-section {
      margin-bottom: 20px;
    }
    .form-group {
      margin-bottom: 15px;
    }
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    select, input[type="text"], input[type="date"], input[type="checkbox"] {
      width: 100%;
      padding: 8px;
      margin-bottom: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    button {
      padding: 10px 20px;
      background-color: #28a745;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    button:hover {
      background-color: #218838;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }
    th {
      background-color: #f2f2f2;
    }
    .hidden {
      display: none;
    }
    .logout-btn {
      background-color: #dc3545;
      margin-top: 10px;
    }
    .logout-btn:hover {
      background-color: #c82333;
    }
    .print-btn {
      background-color: #007bff;
      margin-left: 10px;
    }
    .print-btn:hover {
      background-color: #0056b3;
    }
    #pdfContent {
      display: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <div id="loginSection" class="login-section">
      <h2>Login</h2>
      <div class="form-group">
        <label for="username">Username:</label>
        <input type="text" id="username" placeholder="Masukkan username">
      </div>
      <div class="form-group">
        <label for="password">Password:</label>
        <input type="password" id="password" placeholder="Masukkan password">
      </div>
      <button onclick="login()">Login</button>
    </div>

    <div id="mainSection" class="hidden">
      <h1>Sistem Manajemen Siswa</h1>
      <button class="logout-btn" onclick="logout()">Logout</button>

      <div class="form-section">
        <h2>Form Input Data</h2>
        <div class="form-group">
          <label for="classSelect">Pilih Kelas:</label>
          <select id="classSelect" onchange="updateStudentDropdown()">
            <option value="">Pilih Kelas</option>
          </select>
        </div>
        <div class="form-group">
          <label for="studentSelect">Pilih Nama Siswa:</label>
          <select id="studentSelect">
            <option value="">Pilih Siswa</option>
          </select>
        </div>
        <div class="form-group">
          <label for="parentWhatsApp">Nomor WhatsApp Orang Tua:</label>
          <input type="text" id="parentWhatsApp" placeholder="Masukkan nomor WhatsApp">
        </div>
        <div class="form-group">
          <label for="case">Kasus:</label>
          <input type="text" id="case" placeholder="Masukkan kasus">
        </div>
        <div class="form-group">
          <label for="score">Skor:</label>
          <input type="text" id="score" placeholder="Masukkan skor">
        </div>
        <div class="form-group">
          <label><input type="checkbox" id="lateStatus"> Status Terlambat</label>
        </div>
        <div class="form-group">
          <label><input type="checkbox" id="earlyLeavePermission"> Izin Pulang</label>
        </div>
        <div class="form-group">
          <label for="date">Tanggal:</label>
          <input type="date" id="date">
        </div>
        <div class="form-group">
          <label for="reason">Alasan:</label>
          <input type="text" id="reason" placeholder="Masukkan alasan">
        </div>
        <div class="form-group">
          <label for="teacherSignature">Tanda Tangan Guru Mata Pelajaran:</label>
          <input type="text" id="teacherSignature" placeholder="Masukkan nama guru">
        </div>
        <div class="form-group">
          <label for="picketTeacherSignature">Tanda Tangan Guru Piket:</label>
          <input type="text" id="picketTeacherSignature" placeholder="Masukkan nama guru piket">
        </div>
        <div class="form-group">
          <label for="classTeacherSignature">Tanda Tangan Wali Kelas:</label>
          <input type="text" id="classTeacherSignature" readonly>
        </div>
        <button onclick="addOrUpdateData()">Tambah atau Perbarui Data</button>
      </div>

      <div class="table-section">
        <h2>Data Siswa</h2>
        <table id="dataTable">
          <thead>
            <tr>
              <th>Kelas</th>
              <th>Nama</th>
              <th>WhatsApp Orang Tua</th>
              <th>Kasus</th>
              <th>Skor</th>
              <th>Terlambat</th>
              <th>Izin Pulang</th>
              <th>Tanggal</th>
              <th>Alasan</th>
              <th>Guru Mata Pelajaran</th>
              <th>Guru Piket</th>
              <th>Wali Kelas</th>
              <th>Aksi</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div id="pdfContent">
      <div style="text-align: center;">
        <img src="https://drive.google.com/uc?export=download&id=1A2B3C4D5E6F7G8H9I0J" alt="School Logo" style="width: 100px;">
        <h2>SMA Negeri 1 Contoh</h2>
        <p>Jl. Contoh No. 123, Kota Contoh</p>
        <h3>Surat Izin Pulang</h3>
      </div>
      <p>Kami yang bertanda tangan di bawah ini:</p>
      <p><strong>Nama Siswa:</strong> <span id="pdfStudentName"></span></p>
      <p><strong>Kelas:</strong> <span id="pdfClass"></span></p>
      <p><strong>Tanggal:</strong> <span id="pdfDate"></span></p>
      <p><strong>Alasan:</strong> <span id="pdfReason"></span></p>
      <p>Menyatakan bahwa siswa tersebut diizinkan pulang dengan alasan tersebut di atas.</p>
      <p style="margin-top: 50px;"><strong>Guru Mata Pelajaran:</strong> <span id="pdfTeacherSignature"></span></p>
      <p><strong>Guru Piket:</strong> <span id="pdfPicketTeacherSignature"></span></p>
      <p><strong>Wali Kelas:</strong> <span id="pdfClassTeacherSignature"></span></p>
    </div>
  </div>

  <script>
    const SHEETY_STUDENTS_API_URL = 'https://api.sheety.co/c39dd8e7c916b60608a1fdef0dbb9b88/studentDatabase/students';
    const SHEETY_CLASS_MAPPING_API_URL = 'https://api.sheety.co/c39dd8e7c916b60608a1fdef0dbb9b88/studentDatabase/classMapping';
    const FIXED_WHATSAPP_NUMBER = '6285730809839';
    const SCHOOL_LOGO_URL = 'https://drive.google.com/file/d/1Ufecmx7iQCjveZmI6F4AW7xnsAU-fFQi/view?usp=sharing';

    let classMapping = [];

    function login() {
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;
      if (username === 'admin' && password === 'password123') {
        document.getElementById('loginSection').classList.add('hidden');
        document.getElementById('mainSection').classList.remove('hidden');
        loadData();
        loadClassDropdown();
      } else {
        alert('Username atau password salah!');
      }
    }

    function logout() {
      document.getElementById('loginSection').classList.remove('hidden');
      document.getElementById('mainSection').classList.add('hidden');
      document.getElementById('username').value = '';
      document.getElementById('password').value = '';
    }

    async function fetchStudents() {
      const response = await fetch(SHEETY_STUDENTS_API_URL);
      const data = await response.json();
      return data.students; // Akses array di dalam objek "students"
}

    aasync function fetchClassMapping() {
      const response = await fetch(SHEETY_CLASS_MAPPING_API_URL);
      const data = await response.json();
      return data.classMappings; // Akses array di dalam objek "classMappings"
}

    async function loadClassDropdown() {
      const classes = await fetchClassMapping();
      const classSelect = document.getElementById('classSelect');
      classes.forEach(cls => {
        const option = document.createElement('option');
        option.value = cls.class;
        option.textContent = cls.class;
        classSelect.appendChild(option);
      });
    }

    async function updateStudentDropdown() {
      const classSelect = document.getElementById('classSelect').value;
      const studentSelect = document.getElementById('studentSelect');
      studentSelect.innerHTML = '<option value="">Pilih Siswa</option>';
      const students = await fetchStudents();
      const filteredStudents = students.filter(student => student.class === classSelect);
      const uniqueNames = [...new Set(filteredStudents.map(student => student.name))];
      uniqueNames.forEach(name => {
        const option = document.createElement('option');
        option.value = name;
        option.textContent = name;
        studentSelect.appendChild(option);
      });

      const selectedClass = classMapping.find(cls => cls.class === classSelect);
      document.getElementById('classTeacherSignature').value = selectedClass ? selectedClass.classTeacher : '';
    }

    async function addOrUpdateData() {
      const formData = {
        class: document.getElementById('classSelect').value,
        name: document.getElementById('studentSelect').value,
        parentWhatsApp: document.getElementById('parentWhatsApp').value,
        case: document.getElementById('case').value,
        score: document.getElementById('score').value,
        lateStatus: document.getElementById('lateStatus').checked ? 'Yes' : 'No',
        earlyLeavePermission: document.getElementById('earlyLeavePermission').checked ? 'Yes' : 'No',
        date: document.getElementById('date').value,
        reason: document.getElementById('reason').value,
        teacherSignature: document.getElementById('teacherSignature').value,
        picketTeacherSignature: document.getElementById('picketTeacherSignature').value,
        classTeacherSignature: document.getElementById('classTeacherSignature').value
      };

      const payload = { student: formData };

      await fetch(SHEETY_STUDENTS_API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      alert('Data berhasil ditambahkan!');
      loadData();
    }

    async function loadData() {
      const students = await fetchStudents();
      const tbody = document.querySelector('#dataTable tbody');
      tbody.innerHTML = '';
      students.forEach(student => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${student.class}</td>
          <td>${student.name}</td>
          <td>${student.parentWhatsApp}</td>
          <td>${student.case}</td>
          <td>${student.score}</td>
          <td>${student.lateStatus}</td>
          <td>${student.earlyLeavePermission}</td>
          <td>${student.date}</td>
          <td>${student.reason}</td>
          <td>${student.teacherSignature}</td>
          <td>${student.picketTeacherSignature}</td>
          <td>${student.classTeacherSignature}</td>
          <td>
            <button class="print-btn" onclick="printPermissionLetter(
              '${student.name}',
              '${student.class}',
              '${student.date}',
              '${student.reason}',
              '${student.teacherSignature}',
              '${student.picketTeacherSignature}',
              '${student.classTeacherSignature}'
            )">Cetak Surat Izin</button>
          </td>
        `;
        tbody.appendChild(row);
      });
    }

    function printPermissionLetter(name, className, date, reason, teacherSignature, picketTeacherSignature, classTeacherSignature) {
      document.getElementById('pdfStudentName').textContent = name;
      document.getElementById('pdfClass').textContent = className;
      document.getElementById('pdfDate').textContent = date;
      document.getElementById('pdfReason').textContent = reason;
      document.getElementById('pdfTeacherSignature').textContent = teacherSignature;
      document.getElementById('pdfPicketTeacherSignature').textContent = picketTeacherSignature;
      document.getElementById('pdfClassTeacherSignature').textContent = classTeacherSignature;

      const element = document.getElementById('pdfContent');
      html2pdf().from(element).set({
        filename: `Surat_Izin_${name}_${date}.pdf`,
        margin: 20,
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
      }).save();
    }
  </script>
</body>
</html>